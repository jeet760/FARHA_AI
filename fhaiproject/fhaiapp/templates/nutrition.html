{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>School Orders</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-white border-b shadow-md">
    <div class="max-w-7xl mx-auto px-3 py-3 flex flex-col md:flex-row items-center justify-between gap-3">
      <div class="flex flex-col">
        <a href="/" class="text-xl font-semibold">
          Nutri<span class="text-[#FF9933]">Tracks</span>
        </a>
        <span class="text-sm font-bold text-gray-500">
          Agri-Nutrition Delivery Dashboard
        </span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow w-[90%] max-w-7xl mx-auto py-6 space-y-6" x-data="orderApp()">

    <!-- Dropdown -->
    <div class="bg-white p-6 rounded-xl shadow-md">
      <label class="block mb-3 text-lg font-semibold text-gray-700">Select School:</label>
      <select 
        x-model="selectedSchool" 
        @change="onSchoolChange"
        class="w-full p-3 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400"
      >
        <option value="">-- Choose a School --</option>
        <template x-for="school in schools" :key="school.id">
          <option :value="school.id" x-text="school.first_name"></option>
        </template>
      </select>
    </div>

    <!-- Collapsible 1: School Info -->
    <div x-show="selectedSchool" class="bg-white rounded-xl shadow-md overflow-hidden">
      <button @click="openInfo = !openInfo"
        class="w-full flex justify-between items-center bg-[#FF9933] text-white px-6 py-3 font-semibold hover:bg-purple-700 transition">
        <span>School Info</span>
        <svg :class="{'rotate-180': openInfo}" class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div x-show="openInfo" x-transition class="p-4 overflow-x-auto">
        <table class="w-full border-collapse text-sm md:text-base">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2 border">I</th>
              <th class="p-2 border">II</th>
              <th class="p-2 border">III</th>
              <th class="p-2 border">IV</th>
              <th class="p-2 border">V</th>
              <th class="p-2 border">VI</th>
              <th class="p-2 border">VII</th>
              <th class="p-2 border">VIII</th>
              <th class="p-2 border">IX</th>
              <th class="p-2 border">X</th>
              <th class="p-2 border">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr class="text-center">
              <td class="p-2 border" x-text="getSchoolInfo().i_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().ii_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().iii_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().iv_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().v_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().vi_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().vii_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().viii_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().ix_students"></td>
              <td class="p-2 border" x-text="getSchoolInfo().x_students"></td>
              <td class="p-2 border font-semibold text-purple-600" x-text="getSchoolInfo().total_students"></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Collapsible 2: Nutrition Info -->
    <div x-show="selectedSchool" class="bg-white rounded-xl shadow-md overflow-hidden">
      <button @click="openNutrition = !openNutrition"
        class="w-full flex justify-between items-center bg-green-600 text-white px-6 py-3 font-semibold hover:bg-green-700 transition">
        <span>Proximate Values</span>
        <svg :class="{'rotate-180': openNutrition}" class="h-5 w-5 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
        </svg>
      </button>
      <div x-show="openNutrition" x-transition class="p-4 overflow-x-auto">
        <!-- Export Button -->
        <button onclick="exportTableToExcel('nutritionTable', 'Nutrition_Report')" 
                class="mb-4 px-4 py-2 bg-white text-white rounded hover:bg-gray-200">
          <svg width="20px" height="20px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="a" x1="4.494" y1="-2092.086" x2="13.832" y2="-2075.914" gradientTransform="translate(0 2100)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#18884f"/><stop offset="0.5" stop-color="#117e43"/><stop offset="1" stop-color="#0b6631"/></linearGradient></defs><title>file_type_excel</title><path d="M19.581,15.35,8.512,13.4V27.809A1.192,1.192,0,0,0,9.705,29h19.1A1.192,1.192,0,0,0,30,27.809h0V22.5Z" style="fill:#185c37"/><path d="M19.581,3H9.705A1.192,1.192,0,0,0,8.512,4.191h0V9.5L19.581,16l5.861,1.95L30,16V9.5Z" style="fill:#21a366"/><path d="M8.512,9.5H19.581V16H8.512Z" style="fill:#107c41"/><path d="M16.434,8.2H8.512V24.45h7.922a1.2,1.2,0,0,0,1.194-1.191V9.391A1.2,1.2,0,0,0,16.434,8.2Z" style="opacity:0.10000000149011612;isolation:isolate"/><path d="M15.783,8.85H8.512V25.1h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.783,8.85H8.512V23.8h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.132,8.85H8.512V23.8h6.62a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.132,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M3.194,8.85H15.132a1.193,1.193,0,0,1,1.194,1.191V21.959a1.193,1.193,0,0,1-1.194,1.191H3.194A1.192,1.192,0,0,1,2,21.959V10.041A1.192,1.192,0,0,1,3.194,8.85Z" style="fill:url(#a)"/><path d="M5.7,19.873l2.511-3.884-2.3-3.862H7.758L9.013,14.6c.116.234.2.408.238.524h.017c.082-.188.169-.369.26-.546l1.342-2.447h1.7l-2.359,3.84,2.419,3.905H10.821l-1.45-2.711A2.355,2.355,0,0,1,9.2,16.8H9.176a1.688,1.688,0,0,1-.168.351L7.515,19.873Z" style="fill:#fff"/><path d="M28.806,3H19.581V9.5H30V4.191A1.192,1.192,0,0,0,28.806,3Z" style="fill:#33c481"/><path d="M19.581,16H30v6.5H19.581Z" style="fill:#107c41"/></svg>
        </button>
        <button onclick="exportTableToPDF('nutritionTable', 'Nutrition_Report')" 
                class="px-4 py-2 bg-white text-white rounded hover:bg-gray-200">
          <svg xmlns="http://www.w3.org/2000/svg" 
              width="20px" height="20px" viewBox="0 0 56 64" enable-background="new 0 0 56 64" xml:space="preserve">
            <g>
              <path fill="#8C181A" d="M5.1,0C2.3,0,0,2.3,0,5.1v53.8C0,61.7,2.3,64,5.1,64h45.8c2.8,0,5.1-2.3,5.1-5.1V20.3L37.1,0H5.1z"/>
              <path fill="#6B0D12" d="M56,20.4v1H43.2c0,0-6.3-1.3-6.1-6.7c0,0,0.2,5.7,6,5.7H56z"/>
              <path opacity="0.5" fill="#FFFFFF" enable-background="new    " d="M37.1,0v14.6c0,1.7,1.1,5.8,6.1,5.8H56L37.1,0z"/>
            </g>
            <path fill="#FFFFFF" d="M14.9,49h-3.3v4.1c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h3.7
              c2.4,0,3.8,1.7,3.8,3.6C18.7,47.4,17.3,49,14.9,49z M14.8,43.1h-3.2v4.6h3.2c1.4,0,2.4-0.9,2.4-2.3C17.2,44,16.2,43.1,14.8,43.1z
              M25.2,53.8h-3c-0.6,0-1.1-0.5-1.1-1.1v-9.8c0-0.6,0.5-1.1,1.1-1.1h3c3.7,0,6.2,2.6,6.2,6C31.4,51.2,29,53.8,25.2,53.8z M25.2,43.1
              h-2.6v9.3h2.6c2.9,0,4.6-2.1,4.6-4.7C29.9,45.2,28.2,43.1,25.2,43.1z M41.5,43.1h-5.8V47h5.7c0.4,0,0.6,0.3,0.6,0.7
              s-0.3,0.6-0.6,0.6h-5.7v4.8c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h6.2c0.4,0,0.6,0.3,0.6,0.7
              C42.2,42.8,41.9,43.1,41.5,43.1z"/>
            </svg>
        </button>
        <table id="nutritionTable" class="w-full border-collapse text-sm md:text-base">
          <thead>
            <tr class="bg-gray-100" style="text-align: left;">
              <th class="p-2 border">School</th>
              <th class="p-2 border" colspan="15" x-text="currentSchool.first_name"></th>
            </tr>
            <tr class="bg-gray-100" style="text-align: left;">
              <th class="p-2 border">Students</th>
              <th class="p-2 border" colspan="15" x-text="getSchoolInfo().total_students"></th>
            </tr>
            <tr class="bg-gray-100 text-left">
              <th class="p-2 border" rowspan="2">Item Cat</th>
              <th class="p-2 border" rowspan="2">Item Name</th>
              <th class="p-2 border" rowspan="2">Qty.</th>
              <th class="p-2 border" rowspan="2">Unit</th>
              <th class="p-2 border" colspan="4">Nutrition in Ordered Items</th>
              <th class="p-2 border" colspan="4">Class I-V Per Capita Nutrition</th>
              <th class="p-2 border" colspan="4">Class VI-X Per Capita Nutrition</th>
            </tr>
            <tr class="bg-gray-100 text-left">
              <th class="p-2 border">Protein</th>
              <th class="p-2 border">Fat</th>
              <th class="p-2 border">Carbs</th>
              <th class="p-2 border">Calories</th>
              <th class="p-2 border">Protein</th>
              <th class="p-2 border">Fat</th>
              <th class="p-2 border">Carbs</th>
              <th class="p-2 border">Calories</th>
              <th class="p-2 border">Protein</th>
              <th class="p-2 border">Fat</th>
              <th class="p-2 border">Carbs</th>
              <th class="p-2 border">Calories</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="item in getNutrition()" :key="item.item_name">
              <tr class="hover:bg-gray-50">
                <td class="p-2 border" x-text="item.item_cat"></td>
                <td class="p-2 border" x-text="item.item_name"></td>
                <td class="p-2 border text-center" x-text="item.itemQty"></td>
                <td class="p-2 border text-center" x-text="item.item_unit"></td>
                <td class="p-2 border text-right" x-text="item.protcnt_total.toFixed(2)"></td>
                <td class="p-2 border text-right" x-text="item.fatce_total.toFixed(2)"></td>
                <td class="p-2 border text-right" x-text="item.choavldf_total.toFixed(2)"></td>
                <td class="p-2 border text-right" x-text="item.enerc_total.toFixed(2)"></td>

                <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.protcnt_total/currentSchool.i_v_total).toFixed(2):0"></td>
                <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.fatce_total/currentSchool.i_v_total).toFixed(2):0"></td>
                <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.choavldf_total/currentSchool.i_v_total).toFixed(2):0"></td>
                <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.enerc_total/currentSchool.i_v_total).toFixed(2):0"></td>

                <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.protcnt_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.fatce_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.choavldf_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.enerc_total/currentSchool.vi_x_total).toFixed(2):0"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="bg-gray-500 text-gray-200 py-4">
    <div class="w-[90%] max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center text-sm">
      <p>&copy; <span x-text="new Date().getFullYear()"></span> Powered by <a style="text-decoration: none; color: #ffffff;" href="https://nutritracks.in/farha-ai">FarHa AI</a> | Nutrition Dashboard prototype</p>
      <div class="mt-2 md:mt-0 space-x-4">
        <a href="#" class="hover:underline">Privacy Policy</a>
        <a href="#" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Schools Data -->
  {{ schools|json_script:"schools-data" }}
  <script>
    function orderApp() {
      schools = JSON.parse(document.getElementById("schools-data").textContent);
      return {
        selectedSchool: "",
        currentSchool: null,
        openInfo: true,
        openNutrition: false,
        schools: schools,
        onSchoolChange() {
          this.currentSchool = this.schools.find(s => s.id == this.selectedSchool);
        },
        getOrders() {
          return this.currentSchool ? this.currentSchool.order_details : [];
        },
        getSchoolInfo() {
          return this.currentSchool ? this.currentSchool.school_info : {};
        },
        getNutrition() {
          return this.currentSchool ? this.currentSchool.nutrition_details : [];
        }
      }
    }

    //export to excel
    function exportTableToExcel(tableID, filename = ''){
      let table = document.getElementById(tableID);
      let wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
      XLSX.writeFile(wb, filename ? filename + ".xlsx" : "export.xlsx");
    }
    // PDF Export
    function exportTableToPDF(tableID, filename = ''){
      const { jsPDF } = window.jspdf;
      let doc = new jsPDF('l', 'pt', 'a4'); // landscape, points, A4 size
      doc.text("Nutrition Report", 40, 40);
      doc.autoTable({
        html: '#' + tableID,
        startY: 60,
        theme: 'grid',
        styles: { fontSize: 9 }
      });
      doc.save(filename ? filename + ".pdf" : "export.pdf");
    }
  </script>
</body>
</html>