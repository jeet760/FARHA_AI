{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nutri Tracks — Agri-Nutrition Delivery Dashboard</title>

  <!-- Tailwind (dev CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col text-sm md:text-base" x-data="orderApp()">
  <!-- Header -->
  <header class="bg-white border-b shadow-md">
    <div class="max-w-7xl mx-auto px-3 py-3 flex flex-col md:flex-row items-center justify-between gap-3">
      <div class="flex flex-col">
        <a href="/" class="text-xl font-semibold">
          Nutri<span class="text-[#FF9933]">Tracks</span>
        </a>
        <span class="text-sm font-bold text-gray-500">
          Agri-Nutrition Delivery Dashboard
        </span>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-6 space-y-6 flex-grow">
    <!-- School Section -->
    <div class="bg-white p-4 rounded-xl shadow-md flex flex-col gap-4">
      <!-- Row 1: Label + Dropdown -->
      <div class="flex items-center gap-4 w-full">
        <label class="text-sm md:text-base font-semibold text-gray-700 whitespace-nowrap">Select School:</label>
        <select 
          x-model="selectedSchool" 
          @change="onSchoolChange"
          class="p-2 w-full md:w-72 border rounded-lg shadow-sm focus:ring-2 focus:ring-blue-400 text-sm">
          <option value="">-- Choose --</option>
          <template x-for="school in schools" :key="school.id">
            <option :value="school.id" x-text="school.first_name"></option>
          </template>
        </select>
      </div>

      <!-- Row 2: Bubbles -->
      <div x-show="selectedSchool" class="flex flex-wrap gap-3 justify-center">
        <template x-for="[key, value] in Object.entries(getSchoolInfo())" :key="key">
          <div class="flex flex-col items-center justify-center bg-[#19183B] text-white w-20 h-20 rounded-full shadow-md text-center p-1">
            <!-- ✅ formatted dynamically -->
            <span class="text-[10px] font-bold uppercase leading-tight break-words"
                  x-text="formatLabel(key)"></span>
            <span class="text-base font-semibold" x-text="value"></span>
          </div>
        </template>
      </div>


    <!-- Cards Section -->
    <div x-show="selectedSchool" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
      <!-- Card 1: Proximate Principles -->
      <div class="bg-green-200 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition"
          @click="openNutrition = 'proximate'">
        <h2 class="text-sm md:text-base font-semibold text-gray-700">Proximate Principles and Fibres</h2>
        <p class="text-gray-500 text-xs">Click to view details</p>
      </div>

      <div class="bg-pink-200 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition"
          @click="openNutrition = 'vitamins'">
        <h2 class="text-sm md:text-base font-semibold text-gray-700">Vitamins</h2>
        <p class="text-gray-500 text-xs">Click to view details</p>
      </div>

      <div class="bg-yellow-200 p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition"
          @click="openNutrition = 'minerals'">
        <h2 class="text-sm md:text-base font-semibold text-gray-700">Minerals</h2>
        <p class="text-gray-500 text-xs">Click to view details</p>
      </div>

      <!-- 9 More Blank Cards -->
      <!-- <template x-for="n in 7" :key="n">
        <div class="bg-white p-4 rounded-xl shadow-md cursor-pointer hover:shadow-lg transition"
            @click="openNutrition = 'card' + n">
          <h2 class="text-sm md:text-base font-semibold text-gray-700">Card <span x-text="n"></span></h2>
          <p class="text-gray-500 text-xs">Click to view details</p>
        </div>
      </template> -->
    </div>

    <!-- Modal -->
    <div x-show="openNutrition" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
        x-transition>
      <div class="bg-white rounded-xl shadow-lg w-[95%] max-w-6xl p-6 relative">
        <!-- Close Button -->
        <button @click="openNutrition = false"
                class="absolute top-3 right-3 text-gray-500 hover:text-red-500 text-xl">&times;</button>

        <h2 class="text-base md:text-lg font-semibold mb-4" x-text="openNutrition === 'proximate' ? 'Proximates' : 
        openNutrition === 'minerals' ? 'Minerals' :
        openNutrition === 'vitamins' ? 'Vitamins' : 
        'Card Details'"></h2>
        
        <!-- Export Buttons (only for proximate principles) -->
        <div x-show="openNutrition === 'proximate'" class="flex gap-3 mb-4">
          <span>Export:</span>
          <button onclick="exportTableToExcel('proximatesTable', 'Proximates_Nutrition_Report')" 
                  class="px-3 py-1 bg-white text-white rounded hover:bg-gray-100 text-sm">
            <svg width="20px" height="20px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="a" x1="4.494" y1="-2092.086" x2="13.832" y2="-2075.914" gradientTransform="translate(0 2100)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#18884f"/><stop offset="0.5" stop-color="#117e43"/><stop offset="1" stop-color="#0b6631"/></linearGradient></defs><title>file_type_excel</title><path d="M19.581,15.35,8.512,13.4V27.809A1.192,1.192,0,0,0,9.705,29h19.1A1.192,1.192,0,0,0,30,27.809h0V22.5Z" style="fill:#185c37"/><path d="M19.581,3H9.705A1.192,1.192,0,0,0,8.512,4.191h0V9.5L19.581,16l5.861,1.95L30,16V9.5Z" style="fill:#21a366"/><path d="M8.512,9.5H19.581V16H8.512Z" style="fill:#107c41"/><path d="M16.434,8.2H8.512V24.45h7.922a1.2,1.2,0,0,0,1.194-1.191V9.391A1.2,1.2,0,0,0,16.434,8.2Z" style="opacity:0.10000000149011612;isolation:isolate"/><path d="M15.783,8.85H8.512V25.1h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.783,8.85H8.512V23.8h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.132,8.85H8.512V23.8h6.62a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.132,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M3.194,8.85H15.132a1.193,1.193,0,0,1,1.194,1.191V21.959a1.193,1.193,0,0,1-1.194,1.191H3.194A1.192,1.192,0,0,1,2,21.959V10.041A1.192,1.192,0,0,1,3.194,8.85Z" style="fill:url(#a)"/><path d="M5.7,19.873l2.511-3.884-2.3-3.862H7.758L9.013,14.6c.116.234.2.408.238.524h.017c.082-.188.169-.369.26-.546l1.342-2.447h1.7l-2.359,3.84,2.419,3.905H10.821l-1.45-2.711A2.355,2.355,0,0,1,9.2,16.8H9.176a1.688,1.688,0,0,1-.168.351L7.515,19.873Z" style="fill:#fff"/><path d="M28.806,3H19.581V9.5H30V4.191A1.192,1.192,0,0,0,28.806,3Z" style="fill:#33c481"/><path d="M19.581,16H30v6.5H19.581Z" style="fill:#107c41"/></svg>
          </button>
          <button onclick="exportTableToPDF('proximatesTable', 'Proximates_Nutrition_Report')" 
                  class="px-3 py-1 bg-white text-white rounded hover:bg-gray-100 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" 
                width="20px" height="20px" viewBox="0 0 56 64" enable-background="new 0 0 56 64" xml:space="preserve">
              <g>
                <path fill="#8C181A" d="M5.1,0C2.3,0,0,2.3,0,5.1v53.8C0,61.7,2.3,64,5.1,64h45.8c2.8,0,5.1-2.3,5.1-5.1V20.3L37.1,0H5.1z"/>
                <path fill="#6B0D12" d="M56,20.4v1H43.2c0,0-6.3-1.3-6.1-6.7c0,0,0.2,5.7,6,5.7H56z"/>
                <path opacity="0.5" fill="#FFFFFF" enable-background="new    " d="M37.1,0v14.6c0,1.7,1.1,5.8,6.1,5.8H56L37.1,0z"/>
              </g>
              <path fill="#FFFFFF" d="M14.9,49h-3.3v4.1c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h3.7
                c2.4,0,3.8,1.7,3.8,3.6C18.7,47.4,17.3,49,14.9,49z M14.8,43.1h-3.2v4.6h3.2c1.4,0,2.4-0.9,2.4-2.3C17.2,44,16.2,43.1,14.8,43.1z
                M25.2,53.8h-3c-0.6,0-1.1-0.5-1.1-1.1v-9.8c0-0.6,0.5-1.1,1.1-1.1h3c3.7,0,6.2,2.6,6.2,6C31.4,51.2,29,53.8,25.2,53.8z M25.2,43.1
                h-2.6v9.3h2.6c2.9,0,4.6-2.1,4.6-4.7C29.9,45.2,28.2,43.1,25.2,43.1z M41.5,43.1h-5.8V47h5.7c0.4,0,0.6,0.3,0.6,0.7
                s-0.3,0.6-0.6,0.6h-5.7v4.8c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h6.2c0.4,0,0.6,0.3,0.6,0.7
                C42.2,42.8,41.9,43.1,41.5,43.1z"/>
            </svg>
          </button>
        </div>

        <!-- Proximates Nutrition Table -->
        <div x-show="openNutrition === 'proximate'" class="overflow-x-auto max-h-[70vh]">
          <table id="proximatesTable" class="w-full border-collapse text-xs md:text-sm">
            <thead class="bg-gray-100 text-[#19183B]">
              <tr class="bg-gray-100 font-semibold text-[#19183B]" style="text-align: left;">
                {% if user_type == '3'%}
                <th class="p-2 border">School</th>
                <th class="p-2 border" colspan="18" style="color: black;" x-text="currentSchool?.first_name || ''"></th>
                {% else %}
                <th class="p-2 border">Name</th>
                <th class="p-2 border" colspan="8" style="color: black;" x-text="currentSchool?.first_name || ''"></th>
                {% endif %}
              </tr>
              {% if user_type == '3'%}
              <tr class="bg-gray-100 font-semibold text-[#19183B]" style="text-align: left;">
                <th class="p-2 border">Students</th>
                <th class="p-2 border" style="color: black;" x-text="getSchoolInfo().total_students"></th>
                <th class="p-2 border" colspan="2">Class I-V</th>
                <th class="p-2 border" style="color: black;" x-text="currentSchool?.i_v_total || '0'"></th>
                <th class="p-2 border" colspan="2">Class V-X</th>
                <th class="p-2 border" style="color: black;" x-text="currentSchool?.vi_x_total || '0'"></th>
                <th class="p-2 border" colspan="11"></th>
              </tr>
              {% endif %}
              <tr class="bg-gray-100 text-left">
                <th class="p-2 border" rowspan="2">Category</th>
                <th class="p-2 border" rowspan="2">Item Name</th>
                <th class="p-2 border" rowspan="2">Qty.</th>
                <th class="p-2 border" rowspan="2">Unit</th>
                <th class="p-2 border" colspan="5">Nutrition in Ordered Items</th>
                {% if user_type == '3'%}
                <th class="p-2 border" colspan="5">Class I-V Per Capita Nutrition</th>
                <th class="p-2 border" colspan="5">Class VI-X Per Capita Nutrition</th>
                {% endif %}
              </tr>
              <tr class="bg-gray-100 text-left">
                <th class="p-2 border">Protein (g)</th>
                <th class="p-2 border">Fat (g)</th>
                <th class="p-2 border">Carbs (g)</th>
                <th class="p-2 border">Calories (g)</th>
                <th class="p-2 border">Fibres (g)</th>
                {% if user_type == '3'%}
                <th class="p-2 border">Protein (g)</th>
                <th class="p-2 border">Fat (g)</th>
                <th class="p-2 border">Carbs (g)</th>
                <th class="p-2 border">Calories (g)</th>
                <th class="p-2 border">Fibres (g)</th>
                <th class="p-2 border">Protein (g)</th>
                <th class="p-2 border">Fat (g)</th>
                <th class="p-2 border">Carbs (g)</th>
                <th class="p-2 border">Calories (g)</th>
                <th class="p-2 border">Fibres (g)</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              <template x-for="item in getProximates()" :key="item.item_name">
                <tr class="hover:bg-gray-50">
                  <td class="p-2 border" x-text="item.item_cat"></td>
                  <td class="p-2 border" x-text="item.item_name"></td>
                  <td class="p-2 border text-center" x-text="item.itemQty"></td>
                  <td class="p-2 border text-center" x-text="item.item_unit"></td>
                  <td class="p-2 border text-right" x-text="item.protcnt_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.fatce_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.choavldf_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.enerc_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.enerc_total.toFixed(2)"></td>
                  {% if user_type == '3'%}
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.protcnt_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.fatce_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.choavldf_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.enerc_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.enerc_total/currentSchool.i_v_total).toFixed(2):0"></td>

                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.protcnt_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.fatce_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.choavldf_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.enerc_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.enerc_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  {% endif %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Export Buttons (only for vitamins) -->
        <div x-show="openNutrition === 'vitamins'" class="flex gap-3 mb-4">
          <span>Export:</span>
          <button onclick="exportTableToExcel('vitaminsTable', 'Vitamins_Nutrition_Report')" 
                  class="px-3 py-1 bg-white text-white rounded hover:bg-gray-100 text-sm">
            <svg width="20px" height="20px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="a" x1="4.494" y1="-2092.086" x2="13.832" y2="-2075.914" gradientTransform="translate(0 2100)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#18884f"/><stop offset="0.5" stop-color="#117e43"/><stop offset="1" stop-color="#0b6631"/></linearGradient></defs><title>file_type_excel</title><path d="M19.581,15.35,8.512,13.4V27.809A1.192,1.192,0,0,0,9.705,29h19.1A1.192,1.192,0,0,0,30,27.809h0V22.5Z" style="fill:#185c37"/><path d="M19.581,3H9.705A1.192,1.192,0,0,0,8.512,4.191h0V9.5L19.581,16l5.861,1.95L30,16V9.5Z" style="fill:#21a366"/><path d="M8.512,9.5H19.581V16H8.512Z" style="fill:#107c41"/><path d="M16.434,8.2H8.512V24.45h7.922a1.2,1.2,0,0,0,1.194-1.191V9.391A1.2,1.2,0,0,0,16.434,8.2Z" style="opacity:0.10000000149011612;isolation:isolate"/><path d="M15.783,8.85H8.512V25.1h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.783,8.85H8.512V23.8h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.132,8.85H8.512V23.8h6.62a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.132,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M3.194,8.85H15.132a1.193,1.193,0,0,1,1.194,1.191V21.959a1.193,1.193,0,0,1-1.194,1.191H3.194A1.192,1.192,0,0,1,2,21.959V10.041A1.192,1.192,0,0,1,3.194,8.85Z" style="fill:url(#a)"/><path d="M5.7,19.873l2.511-3.884-2.3-3.862H7.758L9.013,14.6c.116.234.2.408.238.524h.017c.082-.188.169-.369.26-.546l1.342-2.447h1.7l-2.359,3.84,2.419,3.905H10.821l-1.45-2.711A2.355,2.355,0,0,1,9.2,16.8H9.176a1.688,1.688,0,0,1-.168.351L7.515,19.873Z" style="fill:#fff"/><path d="M28.806,3H19.581V9.5H30V4.191A1.192,1.192,0,0,0,28.806,3Z" style="fill:#33c481"/><path d="M19.581,16H30v6.5H19.581Z" style="fill:#107c41"/></svg>
          </button>
          <button onclick="exportTableToPDF('vitaminsTable', 'Vitamins_Nutrition_Report')" 
                  class="px-3 py-1 bg-white text-white rounded hover:bg-gray-100 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" 
                width="20px" height="20px" viewBox="0 0 56 64" enable-background="new 0 0 56 64" xml:space="preserve">
              <g>
                <path fill="#8C181A" d="M5.1,0C2.3,0,0,2.3,0,5.1v53.8C0,61.7,2.3,64,5.1,64h45.8c2.8,0,5.1-2.3,5.1-5.1V20.3L37.1,0H5.1z"/>
                <path fill="#6B0D12" d="M56,20.4v1H43.2c0,0-6.3-1.3-6.1-6.7c0,0,0.2,5.7,6,5.7H56z"/>
                <path opacity="0.5" fill="#FFFFFF" enable-background="new    " d="M37.1,0v14.6c0,1.7,1.1,5.8,6.1,5.8H56L37.1,0z"/>
              </g>
              <path fill="#FFFFFF" d="M14.9,49h-3.3v4.1c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h3.7
                c2.4,0,3.8,1.7,3.8,3.6C18.7,47.4,17.3,49,14.9,49z M14.8,43.1h-3.2v4.6h3.2c1.4,0,2.4-0.9,2.4-2.3C17.2,44,16.2,43.1,14.8,43.1z
                M25.2,53.8h-3c-0.6,0-1.1-0.5-1.1-1.1v-9.8c0-0.6,0.5-1.1,1.1-1.1h3c3.7,0,6.2,2.6,6.2,6C31.4,51.2,29,53.8,25.2,53.8z M25.2,43.1
                h-2.6v9.3h2.6c2.9,0,4.6-2.1,4.6-4.7C29.9,45.2,28.2,43.1,25.2,43.1z M41.5,43.1h-5.8V47h5.7c0.4,0,0.6,0.3,0.6,0.7
                s-0.3,0.6-0.6,0.6h-5.7v4.8c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h6.2c0.4,0,0.6,0.3,0.6,0.7
                C42.2,42.8,41.9,43.1,41.5,43.1z"/>
            </svg>
          </button>
        </div>

        <!-- Vitamins Nutrition Table -->
        <div x-show="openNutrition === 'vitamins'" class="overflow-x-auto max-h-[70vh]">
          <table id="vitaminsTable" class="w-full border-collapse text-xs md:text-sm">
            <thead class="bg-gray-100 text-[#19183B]">
              <tr class="bg-gray-100 font-semibold text-[#19183B]" style="text-align: left;">
                {% if user_type == '3'%}
                <th class="p-2 border">School</th>
                <th class="p-2 border" colspan="18" style="color: black;" x-text="currentSchool?.first_name || ''"></th>
                {% else %}
                <th class="p2 border">Name</th>
                <th class="p2 border" colspan="8" style="color: black;" x-text="currentSchool?.first_name || ''"></th>
                {% endif %}
              </tr>
              {% if user_type == '3'%}
              <tr class="bg-gray-100 font-semibold text-[#19183B]" style="text-align: left;">
                <th class="p-2 border">Students</th>
                <th class="p-2 border" style="color: black;" x-text="getSchoolInfo().total_students"></th>
                <th class="p-2 border" colspan="2">Class I-V</th>
                <th class="p-2 border" style="color: black;" x-text="currentSchool?.i_v_total || '0'"></th>
                <th class="p-2 border" colspan="2">Class V-X</th>
                <th class="p-2 border" style="color: black;" x-text="currentSchool?.vi_x_total || '0'"></th>
                <th class="p-2 border" colspan="11"></th>
              </tr>
              {% endif %}
              <tr class="bg-gray-100 text-left">
                <th class="p-2 border" rowspan="2">Category</th>
                <th class="p-2 border" rowspan="2">Item Name</th>
                <th class="p-2 border" rowspan="2">Qty.</th>
                <th class="p-2 border" rowspan="2">Unit</th>
                <th class="p-2 border" colspan="5">Nutrition in Ordered Items</th>
                {% if user_type == '3'%}
                <th class="p-2 border" colspan="5">Class I-V Per Capita Nutrition</th>
                <th class="p-2 border" colspan="5">Class VI-X Per Capita Nutrition</th>
                {% endif %}
              </tr>
              <tr class="bg-gray-100 text-left">
                <th class="p-2 border">Vit-A (µg)</th>
                <th class="p-2 border">Vit-C (mg)</th>
                <th class="p-2 border">Vit-D (µg)</th>
                <th class="p-2 border">Vit-E (mg)</th>
                <th class="p-2 border">Vit-K (µg)</th>
                {% if user_type == '3'%}
                <th class="p-2 border">Vit-A (µg)</th>
                <th class="p-2 border">Vit-C (mg)</th>
                <th class="p-2 border">Vit-D (µg)</th>
                <th class="p-2 border">Vit-E (mg)</th>
                <th class="p-2 border">Vit-K (µg)</th>
                <th class="p-2 border">Vit-A (µg)</th>
                <th class="p-2 border">Vit-C (mg)</th>
                <th class="p-2 border">Vit-D (µg)</th>
                <th class="p-2 border">Vit-E (mg)</th>
                <th class="p-2 border">Vit-K (µg)</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              <template x-for="item in getVitamins()" :key="item.item_name">
                <tr class="hover:bg-gray-50">
                  <td class="p-2 border" x-text="item.item_cat"></td>
                  <td class="p-2 border" x-text="item.item_name"></td>
                  <td class="p-2 border text-center" x-text="item.itemQty"></td>
                  <td class="p-2 border text-center" x-text="item.item_unit"></td>
                  <td class="p-2 border text-right" x-text="item.vita_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.vitc_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.vitd_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.vite_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.vitk_total.toFixed(2)"></td>
                  {% if user_type == '3'%}
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.vita_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.vitc_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.vitd_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.vite_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.vitk_total/currentSchool.i_v_total).toFixed(2):0"></td>

                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.vita_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.vitc_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.vitd_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.vite_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.vitk_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  {% endif %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Export Buttons (only for minerals) -->
        <div x-show="openNutrition === 'minerals'" class="flex gap-3 mb-4">
          <span>Export:</span>
          <button onclick="exportTableToExcel('mineralsTable', 'Mineral_Nutrition_Report')" 
                  class="px-3 py-1 bg-white text-white rounded hover:bg-gray-100 text-sm">
            <svg width="20px" height="20px" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><linearGradient id="a" x1="4.494" y1="-2092.086" x2="13.832" y2="-2075.914" gradientTransform="translate(0 2100)" gradientUnits="userSpaceOnUse"><stop offset="0" stop-color="#18884f"/><stop offset="0.5" stop-color="#117e43"/><stop offset="1" stop-color="#0b6631"/></linearGradient></defs><title>file_type_excel</title><path d="M19.581,15.35,8.512,13.4V27.809A1.192,1.192,0,0,0,9.705,29h19.1A1.192,1.192,0,0,0,30,27.809h0V22.5Z" style="fill:#185c37"/><path d="M19.581,3H9.705A1.192,1.192,0,0,0,8.512,4.191h0V9.5L19.581,16l5.861,1.95L30,16V9.5Z" style="fill:#21a366"/><path d="M8.512,9.5H19.581V16H8.512Z" style="fill:#107c41"/><path d="M16.434,8.2H8.512V24.45h7.922a1.2,1.2,0,0,0,1.194-1.191V9.391A1.2,1.2,0,0,0,16.434,8.2Z" style="opacity:0.10000000149011612;isolation:isolate"/><path d="M15.783,8.85H8.512V25.1h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.783,8.85H8.512V23.8h7.271a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.783,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M15.132,8.85H8.512V23.8h6.62a1.2,1.2,0,0,0,1.194-1.191V10.041A1.2,1.2,0,0,0,15.132,8.85Z" style="opacity:0.20000000298023224;isolation:isolate"/><path d="M3.194,8.85H15.132a1.193,1.193,0,0,1,1.194,1.191V21.959a1.193,1.193,0,0,1-1.194,1.191H3.194A1.192,1.192,0,0,1,2,21.959V10.041A1.192,1.192,0,0,1,3.194,8.85Z" style="fill:url(#a)"/><path d="M5.7,19.873l2.511-3.884-2.3-3.862H7.758L9.013,14.6c.116.234.2.408.238.524h.017c.082-.188.169-.369.26-.546l1.342-2.447h1.7l-2.359,3.84,2.419,3.905H10.821l-1.45-2.711A2.355,2.355,0,0,1,9.2,16.8H9.176a1.688,1.688,0,0,1-.168.351L7.515,19.873Z" style="fill:#fff"/><path d="M28.806,3H19.581V9.5H30V4.191A1.192,1.192,0,0,0,28.806,3Z" style="fill:#33c481"/><path d="M19.581,16H30v6.5H19.581Z" style="fill:#107c41"/></svg>
          </button>
          <button onclick="exportTableToPDF('mineralsTable', 'Mineral_Nutrition_Report')" 
                  class="px-3 py-1 bg-white text-white rounded hover:bg-gray-100 text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" 
                width="20px" height="20px" viewBox="0 0 56 64" enable-background="new 0 0 56 64" xml:space="preserve">
              <g>
                <path fill="#8C181A" d="M5.1,0C2.3,0,0,2.3,0,5.1v53.8C0,61.7,2.3,64,5.1,64h45.8c2.8,0,5.1-2.3,5.1-5.1V20.3L37.1,0H5.1z"/>
                <path fill="#6B0D12" d="M56,20.4v1H43.2c0,0-6.3-1.3-6.1-6.7c0,0,0.2,5.7,6,5.7H56z"/>
                <path opacity="0.5" fill="#FFFFFF" enable-background="new    " d="M37.1,0v14.6c0,1.7,1.1,5.8,6.1,5.8H56L37.1,0z"/>
              </g>
              <path fill="#FFFFFF" d="M14.9,49h-3.3v4.1c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h3.7
                c2.4,0,3.8,1.7,3.8,3.6C18.7,47.4,17.3,49,14.9,49z M14.8,43.1h-3.2v4.6h3.2c1.4,0,2.4-0.9,2.4-2.3C17.2,44,16.2,43.1,14.8,43.1z
                M25.2,53.8h-3c-0.6,0-1.1-0.5-1.1-1.1v-9.8c0-0.6,0.5-1.1,1.1-1.1h3c3.7,0,6.2,2.6,6.2,6C31.4,51.2,29,53.8,25.2,53.8z M25.2,43.1
                h-2.6v9.3h2.6c2.9,0,4.6-2.1,4.6-4.7C29.9,45.2,28.2,43.1,25.2,43.1z M41.5,43.1h-5.8V47h5.7c0.4,0,0.6,0.3,0.6,0.7
                s-0.3,0.6-0.6,0.6h-5.7v4.8c0,0.4-0.3,0.7-0.8,0.7c-0.4,0-0.7-0.3-0.7-0.7V42.9c0-0.6,0.5-1.1,1.1-1.1h6.2c0.4,0,0.6,0.3,0.6,0.7
                C42.2,42.8,41.9,43.1,41.5,43.1z"/>
            </svg>
          </button>
        </div>

        <!-- Minerals Nutrition Table-->
        <div x-show="openNutrition === 'minerals'" class="overflow-x-auto max-h-[70vh]">
          <table id="mineralsTable" class="w-full border-collapse text-xs md:text-sm">
            <thead class="bg-gray-100 text-[#19183B]">
              <tr class="bg-gray-100 font-semibold text-[#19183B]" style="text-align: left;">
                {% if user_type == '3'%}
                <th class="p-2 border">School</th>
                <th class="p-2 border" colspan="18" style="color: black;" x-text="currentSchool?.first_name || ''"></th>
                {% else %}
                <th class="p-2 border">School</th>
                <th class="p-2 border" colspan="8" style="color: black;" x-text="currentSchool?.first_name || ''"></th>
                {% endif %}
              </tr>
              {% if user_type == '3'%}
              <tr class="bg-gray-100 font-semibold text-[#19183B]" style="text-align: left;">
                <th class="p-2 border">Students</th>
                <th class="p-2 border" style="color: black;" x-text="getSchoolInfo().total_students"></th>
                <th class="p-2 border" colspan="2">Class I-V</th>
                <th class="p-2 border" style="color: black;" x-text="currentSchool?.i_v_total || '0'"></th>
                <th class="p-2 border" colspan="2">Class V-X</th>
                <th class="p-2 border" style="color: black;" x-text="currentSchool?.vi_x_total || '0'"></th>
                <th class="p-2 border" colspan="11"></th>
              </tr>
              {% endif %}
              <tr class="bg-gray-100 text-left">
                <th class="p-2 border" rowspan="2">Category</th>
                <th class="p-2 border" rowspan="2">Item Name</th>
                <th class="p-2 border" rowspan="2">Qty.</th>
                <th class="p-2 border" rowspan="2">Unit</th>
                <th class="p-2 border" colspan="4">Nutrition in Ordered Items</th>
                {% if user_type == '3'%}
                <th class="p-2 border" colspan="4">Class I-V Per Capita Nutrition</th>
                <th class="p-2 border" colspan="4">Class VI-X Per Capita Nutrition</th>
                {% endif %}
              </tr>
              <tr class="bg-gray-100 text-left">
                <th class="p-2 border">Iron (mg)</th>
                <th class="p-2 border">Calcium (mg)</th>
                <th class="p-2 border">Magnesium (mg)</th>
                <th class="p-2 border">Phosphorus (mg)</th>
                {% if user_type == '3'%}
                <th class="p-2 border">Iron (mg)</th>
                <th class="p-2 border">Calcium (mg)</th>
                <th class="p-2 border">Magnesium (mg)</th>
                <th class="p-2 border">Phosphorus (mg)</th>
                <th class="p-2 border">Iron (mg)</th>
                <th class="p-2 border">Calcium (mg)</th>
                <th class="p-2 border">Magnesium (mg)</th>
                <th class="p-2 border">Phosphorus (mg)</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              <template x-for="item in getMinerals()" :key="item.item_name">
                <tr class="hover:bg-gray-50">
                  <td class="p-2 border" x-text="item.item_cat"></td>
                  <td class="p-2 border" x-text="item.item_name"></td>
                  <td class="p-2 border text-center" x-text="item.itemQty"></td>
                  <td class="p-2 border text-center" x-text="item.item_unit"></td>
                  <td class="p-2 border text-right" x-text="item.fe_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.ca_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.mg_total.toFixed(2)"></td>
                  <td class="p-2 border text-right" x-text="item.p_total.toFixed(2)"></td>
                  {% if user_type == '3'%}
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.fe_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.ca_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.mg_total/currentSchool.i_v_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.i_v_total!=0?(item.p_total/currentSchool.i_v_total).toFixed(2):0"></td>

                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.fe_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.ca_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.mg_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  <td class="p-2 border text-right" x-text="currentSchool.vi_x_total!=0?(item.p_total/currentSchool.vi_x_total).toFixed(2):0"></td>
                  {% endif %}
                </tr>
              </template>
            </tbody>
          </table>
        </div>

        <!-- Placeholder for other cards
        <div x-show="openNutrition !== 'proximate' || openNutrition !== 'vitamins' || openNutrition !== 'minerals'" class="text-gray-500 text-sm">
          Data Coming Soon.
        </div> -->
      </div>
    </div>
  </main>
  <!-- Footer -->
  <footer class="bg-gray-500 text-gray-200 py-3 text-xs md:text-sm">
    <div class="w-[90%] max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center">
      <p>&copy; <span x-text="new Date().getFullYear()"></span> Powered by 
        <a href="https://nutritracks.in/farha-ai" class="hover:underline">FarHa AI</a>
      </p>
      <div class="mt-1 md:mt-0 space-x-3">
        <a href="https://farmerharvest.in/privacy-policy" class="hover:underline">Privacy Policy</a>
        <a href="https://farmerharvest.in/contact" class="hover:underline">Contact</a>
      </div>
    </div>
  </footer>

  <!-- Schools Data -->
  {{ schools|json_script:"schools-data" }}
  <script>
    function orderApp() {
      schools = JSON.parse(document.getElementById("schools-data").textContent);
      return {
        selectedSchool: "",
        currentSchool: null,
        openNutrition: false,
        schools: schools,
        onSchoolChange() {
          this.currentSchool = this.schools.find(s => s.id == this.selectedSchool);
        },
        getOrders() {
          return this.currentSchool ? this.currentSchool.order_details : [];
        },
        getSchoolInfo() {
          return this.currentSchool ? this.currentSchool.school_info : {};
        },
        getProximates() {
          return this.currentSchool ? this.currentSchool.proximates_details : [];
        },
        getVitamins(){
          return this.currentSchool ? this.currentSchool.vitamins_details : [];
        },
        getMinerals(){
          return this.currentSchool ? this.currentSchool.minerals_details : [];
        },
        formatLabel(key) {
          const map = {
            pre_primary_students: "Pre-Primary",
            total_students: "Total",
            total_students_with_preprimary: "Grand Total"
          };
          return map[key] || key.replaceAll("_students", " "); // fallback = readable text
        }
      }
    }

    // Excel export
    function exportTableToExcel(tableID, filename = ''){
      let table = document.getElementById(tableID);
      let wb = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
      XLSX.writeFile(wb, filename ? filename + ".xlsx" : "export.xlsx");
    }
    // PDF export
    function exportTableToPDF(tableID, filename = ''){
      const { jsPDF } = window.jspdf;
      let doc = new jsPDF('l', 'pt', 'a4');
      doc.text("Nutrition Report", 40, 40);
      doc.autoTable({ html: '#' + tableID, startY: 60, theme: 'grid', styles: { fontSize: 9 } });
      doc.save(filename ? filename + ".pdf" : "export.pdf");
    }
  </script>

</body>
</html>
